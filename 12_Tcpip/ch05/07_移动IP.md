
与移动设备进行通信时，所连接的子网一旦发生变化，则无法通过 TCP 继续通信。这是因为 TCP 是面向连接的协议，自始至终都需要发送端和接收端主机的 IP 地址不发生变化。

在 UDP 的情况下也无法继续通信，不过鉴于 UDP 是面向非连接的协议，或许可以在应用层面上处理变更 IP 地址的问题。然而，改造所有应用让其适应 IP 地址变更不是件容易的事。

由此，Mobile IP 应运而生。这种技术在主机所连接的子网 IP 发生变化时，主机 IP 地址仍可以保持不变．应用不需要做任何改动，即使是在 IP 地址发生变化的环境下，通信也能够继续。


### 概述

- 移动 IP 允许一台计算机同时拥有两个地址：
    + 一个是应用程序使用的长期且固定的地址
    + 另一个是临时的次地址
- 移动主机的主地址是主机在归属网上分配得到的。当它移动到外地网并获得一个次地址后，移动主机
  必须将这个次地址发往归属代理，通常这个代理是归属网中的一个路由器。这个代理同意截获发送给
  移动主机主地址的数据报，并使用 IP-in-IP 封装方式，把每个数据报以隧道方式传递到次地址。
- 如果移动主机再次变换地点，它会获得一个新的次地址，并将其新位置通知归属代理。当移动主机返
  回归属网后，它必须联系归属代理以便撤销登记，也就是说，让代理停止截获数据报。
- 由于每次移动后都需要相当大的额外开销，所以移动 IP 是为主机移动并不频繁，并且在给定位置停
  留相对较长的一段时期的情况而设计的。

## 移动编址细节
- 移动主机的主址，或称归属地址就是常规的 IP 地址，它的分配和管理与常规 IP 地址相同。
- 在主机访问某个外地网时就会获得一个次地址，又称为转交地址。只有移动主机以及归属网或外地网
  中的代理上的 IP 软件才会使用这个地址。
- 应用程序只使用主地址。
- 根据地址的获取方式及负责转发的实体不同，转交地址分为两种：同址转交地址和外地代理转交地址。
- 由网络管理员决定获取哪种转交地址。

## 代理登记
- 移动主机必须首先进行登记，才能够在外地接收数据。
- 如果移动主机获得的是同址转交地址，则由移动主机直接登记，即移动主机通过这个转交地址直接与
  其归属代理通信。如果移动主机得到的是来自外地代理的转交地址，则移动主机应允许外地代理作为
  自己的全权代表完成登记。
- 在使用同址转交地址的情况下，移动主机直接向其归属代理发送请求。否则，移动主机将请求发送到
  外地代理，然后由外地代理将该请求转发到归属代理。只要用到了外地代理，外地代理和归属代理都
  要批准才能完成登记。

## 与外地代理之间的通信
- 如果移动主机没有唯一的外地地址，当移动主机向外地代理发送数据报时，允许移动主机使用自己的
  归属地址作为 IP 源地址。反之，当外地代理向移动主机发送数据报时，允许代理使用移动主机的归
  属地址作为 IP 目的地址。这样不依靠 ARP 进行地址绑定，而是由代理请求到达时记录移动主机的硬
  件地址，并将记录的信息绑定，通过硬件单播向移动主机发送数据报。

## 数据报的传输和接收
- 登记完成后，外地网的移动主机如果要与任何一台计算机进行通信，在创建数据报时，其目的地址字
  段中的地址就是目的计算机的地址，而源地址字段中的地址是移动主机的归属地址。
- 移动主机数据报从外地网到达目的计算机，但返回的数据报不会直接到达移动主机，而是首先到达移
  动主机的归属网。因为归属代理在登记时已经掌握了移动主机的位置，所以它可以截获数据报，并使
  用 IP-in-IP 封装通过隧道把数据送到同址转交地址(移动主机)或外地代理转交地址(移动主机正在使
  用的外地代理)。

## 与归属网上的计算机之间的通信
- 当移动主机的归属网中有一台主机向移动主机发送数据报时，因为 IP 指明的是通过本地网络直接交付
  ，所以发送方不会将数据转发到路由器上。
- 当移动主机已经移动到一个外地网上时，归属代理通过代理 ARP 方式将自身硬件地址映射为目的地址，
  本地主机被归属代理蒙骗而将所有的目的为移动主机的数据报都转发到归属代理上，然后由归属代理将
  这些数据报转发给移动主机。
