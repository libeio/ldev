
逐一为每一台主机设置 IP 地址是一件非常繁琐的事情。

为了实现自动设置 IP 地址，统一管理 IP 地址的分配，就产生了 DHCP 协议。有了DHCP，计算机只要连接到网络，就可以进行 TCP/IP 通信。也就是说，DHCP 让即插即用变得可能。

DHCP 不仅在 IPv4 中，在 IPv6 中也可以使用。

使用 DHCP 之前，首先要架设一台 DHCP 服务器。然后将 DHCP 所要分配的 IP 地址设置到服务器上。此外，还需要将相应的子网掩码、路由控制信息以及 DNS 服务器的地址等设置到服务器上。


### 认识 DHCP

地址获取方式
* 本地网络获取: 为了使用 DHCP，主机通过向本地网络中的所有服务器广播一个报文而成为客户，然后该主机收集由各个服务器提供的响应，从中选择一个，并与该服务器进一步验证接受事宜。
* 非本地网络获取(中继代理)
    * 一台多地址机器会与多个网络相连接。多地址机器启动时可能需要为每个接口都获取配置信息，但是 DHCP 报文只提供一个接口的信息。有多个接口的计算机必须分开处理每个接口。
    * DHCP 通过中继代理允许计算机与非本地网络上的服务器联系。
    * 当中继代理接收到来自客户端的广播申请时，它会将申请转发到服务器，然后返回服务器发给主机的响应。
    * 中继代理使多地址配置变得复杂，因为服务器可能会收到来自同一台主机的多个请求。

DHCP 重传策略
* DHCP 使用 UDP 携带报文，并且 UDP 报文要封装在 IP 数据报中交付。DHCP 要求 UDP 必须使用检验技术。
* 为处理数据报的丢失问题，DHCP 采用常规的超时和重传技术。
* 当客户发送一个请求时，启动一个计时器。如果超时没有收到响应，那么客户就重传请求。
* 为避免同时传输造成网络拥塞，DHCP 建议使用随机时延，每次重传后在允许范围内定时加倍。

DHCP 报文格式内容
* 把发送 DHCP 请求的机器称为客户，把发送响应的任何机器都称为服务器。
* 客户应尽量填写其所知道的信息，比如服务器 IP 地址或服务器主机名，如果这些字段非零，那么只有与名字或地址字段匹配的服务器才能响应请求；若它们为空，收到请求的任何一台服务器都可以响应。
* 如果一个请求报文中客户的 IP 地址为零，服务器会在 IP 地址字段中返回客户的 IP 地址。
* 客户用标志字段最高位来控制服务器在发送响应时是采用单播还是广播。
* 为了保证客户能够接收由 DHCP 服务器发送来的报文，它可以请求服务器使用 IP 广播方式发送响应，相当于硬件广播。IP 数   据报的处理规则允许丢弃目的地址与计算机地址不匹配，并通过硬件单播到达的任何数据报，但是要求IP接受并处理任何发往 IP 广播地址的数据报。


### 动态配置方式

DHCP 允许三种地址分配方式。
* 人工配置：由管理员为每台具体的计算机指定一个具体的地址
* 自动配置：管理员让 DHCP 服务器为第一次连接网络的计算机分配一个永久的地址
* 动态配置：服务器在一定的期限内把地址"租"给一台计算机

DHCP 根据客户的身份以及服务器配置文件决定如何进行处理。客户与 DHCP 联系时，客户发出一个标识符，通常是客户的硬件地址，服务器根据客户的标识符和客户所连接的网络，决定如何分配客户和 IP 地址。

管理员可以通过对服务器进行设置，让它为某些特定计算机静态地分配地址，同时为其他计算机动态地分配永久地址或临时地址。


### DHCP 租用

概念
* 动态地址分配是临时的，服务器在地址分配时指明其租期，租期结束时，客户必须续租或停止使用该地址。
* 租期的最优时间与特定的网络环境和特定的主机需求有关。比如为了可以尽快循环使用地址，租期应当设置短一些。
* 客户申请一个具体的租期，并由服务器通知客户它所认可的租期。

提前终止租期
* 无论任何情况下，当不再需要一个地址时，DHCP 允许客户提前终止租期，而不用等租用期满。
* 为了提前终止租期，客户向服务器发送一个 DHCP 释放报文，发送释放报文后，客户就不能再使用此地址发送其他数据报了。

租用续组状态: DHCP 客户获得一个地址以后就进入绑定状态。进入绑定状态的客户会设置三个定时器，分别是：
* 控制租用续租: 总租期一半，到期时必须尝试向租用服务器发出续租请求
* 重新绑定: 总租期87.5%，续租成功前此期限到达，主机会在本地网络进行广播，尝试通过任意一台服务器重新绑定其地址。
* 租用到期: 很少会触发

### DHCP 只起分配 IP 地址的作用

虽然 DHCP 可以根据需要为计算机分配 IP 地址，但 DHCP 无法自动完成将主机永久连接到因特网上所需的全部过程。

DHCP 协议没有指明任何与域名系统之间的交互，除非声明另外一种机制，否则主机名与分配给主机的 IP 地址之间的绑定肯定是相互独立的。
