
## 概述
- ICMP 消息以 IP 数据包形式传送，允许路由器向其他路由器或主机发送差错或控制报文，用于与网络
  错误和问题有关的带外数据(out-of-band, OOB)。
- 所有使用 IP 的主机和路由器都必须使用 ICMP。
- ICMP 消息的主要功能是提供对可能发生在通信环境中的各种问题的反馈，而不是对 IP 附加可靠性。
  需要进行可靠通信时，作为 IP 客户机运行的更高层协议必须执行其自己的可靠性程序。
- ICMP 报文交付
    + ICMP 报文需要两级封装，每个 ICMP 报文被放在 IP 数据报的数据部分，通过互联网传送，而
      IP 数据报本身被放在帧的数据部分，通过物理网络传送。
    + 每个 ICMP 报文放在 IP 数据报的数据部分通过互联网传递，携带 ICMP 报文的数据报与携带用
      户信息的数据报具有完全相同的选路，没有附加的可靠性或优先级。因此，差错报文本身可能会
      丢失或被丢弃。
    + 使用 IP 传递 ICMP 报文是因为可能需要经过几个物理网络才能到达其最终目的地，不能仅使用
      物理传输交付它们。
    + 规定：不为携带 ICMP 差错报文的数据报中出现的差错而生成 ICMP 报文。

## ICMP 报头格式
- 协议报文格式
  ```shell
    +----------------+----------------+---------------------------------+
    |    类型(8)     |       编码     |             校验和              |
    +----------------+----------------+---------------------------------+
    |                               标识符                              |
    +---------------------------------+---------------------------------+
    |                             可选数据                              |
    +-------------------------------------------------------------------+
  ```
- 字段说明
    + 类型字段:
      占用 8 比特。指定消息含义和数据包其余部分的格式。
    + 代码字段:
      占用 8 比特。提供有关消息类型的附加信息。如在 ICMP 目的结点不可达消息类型中，通过代码
      "5" 表示源路由失败。
    + 校验和字段:
      占用 16 比特。为整个 ICMP 消息提供校验和。
    + 标识符字段:
      占用 32 比特。预留用。
    + 信息字段:
      占用 32 比特。可选数据。
    
## ICMP 类型字段与消息类型

|  类型字段 |      消息类型     |
|:---------:|:-----------------:|
|    0      |     回送应答      |
|    3      |     目的结点不可达|
|    4      |     源结点抑制    |
|    5      |     重定向        |
|    8      |     回送请求      |
|    11     |     时间超出      |
|    12     |     参数问题      |
|    13     |     时标请求      |
|    14     |     时标应答      |
|    15     |     信息请求      |
|    16     |     信息应答      |
|    17     |     地址掩码请求  |
|    18     |     地址掩码应答  |
- 源站抑制 
- 重定向
- 回送请求和回送应答:
  这两种 ICMP 消息提供了一种用于确定两台计算机之间是否可以进行通信的机制。ping 命令就是使用
  此种 ICMP 消息检查两台主机之间的可达性。
- 时标请求和时标应答:
  这两种 ICMP 消息提供了一种对网络延迟特性进行取样的机制。
- 信息请求和信息应答:
  主机用 ICMP 信息请求消息查找其所连接网络的地址。
- 地址掩码请求和地址掩码应答:
  主机可以用"地址掩码请求"消息来查找其所连接网络的子网掩码。主机在网络上广播请求，并等待路
  由器以包含子网掩码的"地址掩码应答"消息应答。

## ICMP 报文消息类型 - 通过源站抑制报文来实现拥塞时的流量控制
- 拥塞的原因：
    + 第一，一个高速计算机产生通信量的速度比网络所能传输的更快；
    + 第二，如果许多计算机同时需要需要通过某一个路由器发送数据报，即使没有单独哪个源站导致
      拥塞的发生，但该路由器仍可能会发生拥塞。
- 源站抑制实现
    + 通信量过多会致使主机或路由器耗尽内存，近而必须放弃到达的其他数据报。机器为每个被丢弃
      的数据报发送一个源站抑制报文，请求源站减慢当前的数据报传输速率。
    + 主机收到源站抑制报文后，就会降低发报速率，直到不再收到源站抑制报文。然后，只要没有进
      一步收到源站抑制请求，它就会逐渐提高数据报发送速率。

## ICMP 报文消息类型 - 路由重定向
- ICMP重定向机制：它允许主机启动时只知道本地网络上的一个路由器地址。当主机把一个数据报发送
  到初始知道的那个路由器，而该路由器知道数据报有另外一条更佳的路由时，路由器就会向主机发送
  一个 ICMP 重定向报文，请求该主机改变其路由。
- 重定向报文仅限于在直接连到同一物理网络上的路由器和主机之间交互，并没有一般性地解决路由信
  息传播的问题。
- 一般规则，路由器只向主机而不向其他路由器发送 ICMP 重定向请求。

## ICMP 报文消息类型 - 路由超时
- 为了避免数据报在 TCP/IP 互联网上无休止地循环，每个 IP 数据报都有一个生存计数器，有时称为
  跳计数器。只要路由器处理了数据报，就会将数据报的生存时间计数器的值减 1，当计数器的值达到
  0 时就丢弃数据报。
- 一旦路由器跳计数器递减到 0，或因为等待数据报分片(以重装)时出现超时而丢弃它，路由器就向数
  据报的源站发回一个 ICMP 超时报文。