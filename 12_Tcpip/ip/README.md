
## 互联网的无连接交付与网际协议
- 从技术角度讲，互联网服务被定义为不可靠的、尽最大努力交付的、无连接分组交付系统。
    + 不可靠: 分组可能丢失、重复、延迟或不按次序交付，但服务检测不到这些情况，也不会通知发
      送方或接收方。
    + 尽最大努力交付：互联网软件努力尝试发送每个分组。
    + 无连接：每个分组都被独立处理，分组序列可能途径不同的路径。
- 定义这种不可靠、无连接交付机制的协议称为网际协议(IP)。
- IP 提供了三个重要的定义：
    + 第一，IP 定义了在整个 TCP/IP 互联网中使用的数据传送基本单元；
    + 第二，IP 软件完成转发的功能，选择分组转发的路径；
    + 第三，IP 包含一组体现不可靠分组交付思路的规则。
- IP 的不可靠分组交付特性
    + 尽力服务，几乎不提供数据差错控制或跟踪。IP 提供了一个 16 位报送检验和，接收结点可用
      它来验证数据包传送的正确性；如果数据包的检验和无效，接收结点便丢弃该数据包。
    + 不提供端对端或转发到转发的确认功能；
    + 不提供对丢失或破坏数据的重传机制；
    + 不提供流量控制或数据包排序机制。
    
## IPv4 数据报
- 概念
    + 在一个物理网络上，传输的单元是一个包含首部和数据的帧，首部给出了(物理)源地址和目的地
      址之类的信息。互联网把它的基本传输单元称为 Internet 数据报(也称为 IP 数据报或数据报)。
    + IPv4 数据报格式限制数据报的长度为 2^16 个字节。但实际上，数据报通常不超过 1500 个字节
      (因而它们正好可被放到一个以太网帧中)。
- 格式:
  由 IP 报头和数据两部分组成。IP 报头包含一个 20 Bytes 的固定长度部分和一个可变长度部分，后
  者最多可达 40 Bytes，包含有关路由选择和交付的重要信息。
  ```shell
    |<-----------------------------20~65535B------------------------------->|
    |<-20~60B->|                                                            |
    +----------+------------------------------------------------------------+
    |   报头   |                          数据                              |
    +----------+------------------------------------------------------------+
    IP 报头内容如下:
    +----------+----------+--------------------+----------------------------------------+
    |  版本号  | 报头长度 |     区分服务       |                总长度                  |
    +----------+----------+--------------------+-----+----------------------------------+
    |                标识符                    |标志 |           段偏移值               |
    +----------+----------+--------------------+-----+----------------------------------+
    |     生存时间        |     协议类型       |             报头校验和                 |
    +---------------------+--------------------+----------------------------------------+
    |                                  源 IP 地址                                       |
    +-----------------------------------------------------------------------------------+
    |                                 目的 IP 地址                                      |
    +-----------------------------------------------------------------------------+-----+
    |                               可选项（0或多个）                             |填充 |
    +-----------------------------------------------------------------------------+-----+
  ```
  字段说明:
    + 版本号:
      占用 4 个比特。
    + 报头长度: 
      占用 4 个比特，用于表示 32 比特字长的报头长度。1 个单位表示 4 个字节的长度，不含填充时
      值为 5 ，表示 20 个字节。
    + 区分服务: 
      用于指定数据报所要求的服务质量(QoS)。
    + 总长度字段: 
      占用 16 个比特，用于表明 IP 数据报的字节长度，其中包括报头长度和数据长度
      (数据长度 = 总长度 - 报头长度)。IP 数据报的最大长度为 65535 字节，而所有主机必须支持的
      数据包最短长度为 576 字节。
      大多数数据报被分段并封装在较小的多个帧中。
    + 标识符字段: 
      每个数据报都必须由唯一的标识符来标识，以便使接收主机能确定新到达的分段属于哪一个数据报
      ，从而重装被分段的数据报。同一个数据报的所有分段包含同样的标识符。标识符字段占用 16 个
      比特。
    + 标志位字段:
      占用 3 个比特，用于分段控制。这 3 个位(从左到右依次为第 0 位到第 2 位)的含义如下: 第 0 
      位为预留位。每 1 位为可否分段标志位。当该位的值为 0 时，表示数据报不可分段；其值为 1 时，
      表示数据报可被分段。第 2 位为段是否结束位。当该位的值为 0 时，表示该段是原数据报的最后
      一段；其值为 1 时，表示后面还有更多的分段。
      当网络设备要发送的数据报长度比所在网络的最大传输单元大，同时标志位的第 1 位设置为不能分
      段(值为 0)时，网络设备会向发送方返回一个因特网控制消息协议错误消息，并丢弃该数据报。
    + 段偏移字段:
      占用 13 个比特，用于指定分段在原始数据中的相对位置。第 1 个分段的段偏移字段为 0，其余分
      段的段偏移以 8 个字节为单位进行计数，表示该段数据在原始数据报数据区中的偏移量。
    + 生存时间字段:
      占用 8 个比特，用于指定数据报允许保留在网络上的时间(单位是秒)。数据包经过每个网关和主机
      时，都对该字段的值递减 1 ,当其值为 0 时网络设备便丢弃该数据包。
    + 协议字段:
      占用 8 个比特，用于指定数据报数据区中携带的消息是由哪种高级协议建立的。例如，TCP 协议号
      是 0x06 ，UDP 协议号是 0x17 ,ICMP 协议是 0x01，IGMP 协议是 0x02。更多查看 RFC 790。
    + 报头校验和字段:
      占用 16 个比特，当报头每经过一个跳步时，校验和都会被重新计算。
    + 源 IP 地址和目的 IP 地址:
      均占用 32 个比特。在数据包通过网络传送的过程中其值不会发生变化。
    + 选项字段:
      长度可变，它用于各种选项，如记录所采用的路由、指定要采用的路由以及时间标记等。其主要上手
      是为网络管理员提供测试和调试网络的工具。
    + 填充字段:
      保证 IP 报头以 32 位结束。
- IPv4 数据报封装
    + IP 报头和 IP 数据在以太网帧中的数据封装如下:
      ```shell
        +----------+----------+----------+-----------------------------+-----------------+
        | 目的地址 |  源地址  | 长度类型 |以太网数据(IP 报头 + IP 数据)|循环冗余检验(CRC)|
        +----------+----------+----------+-----------------------------+-----------------+
      ```
    + 物理网络帧必须由硬件识别，而数据报是在软件中进行处理的。
    + 为使互联网的传输更为有效，会将每个数据报放入独立的物理帧中传输，这种传输方式称为封装。
    + 物理帧在网络中传输时也叫网络物理帧或网络帧。
- IPv4 数据报分片
    + 理想情况下，整个数据报被封装在一个物理帧中，使物理网络上的传输非常有效。事实却是：每
      种分组交换技术都对一个物理帧可传输的数据量规定了一个固定上界，称为网络最大传输单元或
      MTU。
    + 在 MTU 较小的网络上，可以把长数据报通过分片操作划分成更小块的数据报片。
    + 分片通常发生在路由器上。数据报片的大小必须是 8 的倍数。
    + 为了产生原始数据报的完整副本，在目的站处理之前必须对收到的数据报片进行重组。
    + IP 协议并不把数据报限制到很小，但也不保证大的数据报交付时不被分片。源站可以任意选择合
      适的数据报大小，分片和重组自动进行，源站不必采取任何特殊动作。
    + 路由器必须能够接受所连网络中最大 MTU 大小的数据报。
    + 数据报分片后的每片格式都与原来的数据报相同。每个数据报片都包含一个数据报首部，该首部基
      本复制了原始数据报的首部，首部后面是数据报片携带的数据，同时让数据报片的总长度始终保持
      小于传输它的底层网络的 MTU 大小。
- IPv4 数据报重组
    + 数据报片可以独立的选择路由，重组在目的站进行。
    + 接收机器从它收到初始片开始时启动一个重组计时器，若在所有分片到达之前超时，则丢弃已收到
      的分片，不处理数据报。
- IPv4 数据报分片控制
    + 数据报首部中的标识、标志、片偏移量控制着数据报的分片和重装。
    + 目的主机通过标识字段和源站地址识别数据报片属于哪个数据报。
    + 数据报片的片偏移量字段指明数据报片所携带数据在原始数据报中的偏移量(以8比特为单位)。
    + 存放控制比特位，包括指明数据报是否可分片、是否是原始数据报的尾部等。
- IPv4数据报的生存时间
    + TTL 字段指明数据报在互联网系统中允许保留多长时间(秒计)。
    + 生存时间起着"跳数限制"的作用，而不是延迟时间的估计。
    + 路径沿线的每个路由器(即每一跳)将生存时间字段值递减 1，减至 0 时路由器就会丢弃该数据报，
      并向源站发送一个差错报文。
