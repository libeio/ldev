
## 路由选择体系结构 
- 核心路由选择结构
    + 因特网的设计人员所选的路由器体系结构由少量中心路由器和大量外围路由器组成，中心路由器
      保存了所有可能目的站的全部信息，而大量外围路由器仅保存部分信息。
    + 保存全部信息的中心路由器集合称为因特网的核心，有时也称为无默认区。
    + 核心路由选择体系结构的优点是，因为非核心路由器使用部分信息，某个外围的网点可以自主地
      变更局部的路由。缺点是某个网点可能造成不一致性，使一些目的站不可达。
- 从核心结构到对等主干网结构
    + 实际上，因特网从一个中心的主干网发展成一组对等主干网络，或简称对等方。
    + 对于大多数对等主干网的配置，一对地理位置接近的主机之间的通信量应该选择最短路径。

## 路由选择概述
- 路由选择过程
    + 路由器从所连接网络之一接收数据。
    + 路由器把数据传递到协议栈的网际层。换句话说，路由器抛弃网络访问层报头信息，并重组 IP 
      数据报(若有必要)。
    + 路由器检查 IP 报头中的目的地址。
    + 如果数据的目的在其他网络，路由器就根据路由表决定向哪里转发数据。
    + 在路由器决定了它的哪个适配器要接收这个数据后，就把数据传递到适当的网络访问层软件，让
      数据通过适配器进行传输。
- 路由选择类型
    + 静态路由：要求网络管理员手工输入路由信息。
    + 动态路由：根据使用路由协议获得的路由信息来动态建立路由表。
- 动态路由协议算法
    + 距离向量路由选择
        + 每个路由器定期把自己的路由表副本发送给与其直接相连的其他路由器。
        + 当来自路由器 J 的报告到达路由器 K 之后，K检查这个报告中列出的目的站以及到各个目的
          站的距离，更新自己的路由表。
        + 距离向量算法对变化反应太慢。
        + 距离向量算法因为要求每个路由器都参与进来，进行大量的报文交换，无法适应网络规模变大
          的情况。
    + 链路状态(SPF)路由选择
        + 每个路由器都视作一个结点，能够直接通信(即连接到同一物理网络)的路由器相连构成一条边，
          所有结点与边构成一张"图"。
        + 每个参与的路由器都保存这张"图"。
        + 每个路由器并不发送包含目的站列表的报文，只需要：
            + 第一，积极检测所有相邻路由器的状态；
            + 第二，向所有其他路由器定期传播链路状态信息，更新"图"。
        + SPF 算法使用 Dijkstra 最短路径算法来进行路由选择。
        + SPF 算法报文长短与网络数目无关，更适合用于大规模的互联网。
- 动态路由协议封装
    + 现在的路由选择协议通常把报文封装到UDP中。
- 路由分组
    + 尽管路由器需要交换路由信息，但是在一个任意规模的互联网中让所有路由器都参与某个路由更新
      协议是不现实的，所以路由器要进行分组以减少通信量。
    + 一个启发式指导原则：在一个广域网上最多允许12个路由器参与单个路由信息协议就会很安全；在
      一组局域网上最多允许 60 个左右的路由器参与也会很安全。
    + 将划分到一个组内的路由称为参与路由，新添加到网络但未包含在组内的路由称为非参与路由。
    + 非参与路由使用组内的一个参与路由作为默认路由进行交付时，可能出现最优路由的问题，这种路
      由选择异常现象称为额外跳(extra hop)问题。
    + 参与路由不能使用 ICMP 重定向报文来通知非参与路由其路由不是最优的，因为 ICMP 重定向报文
      只能发送到初始源站，而不能发送到中间路由器。
    
## 对等网络间的路由选择
- 自治系统
    + 出于路由选择的目的，由单个管理机构控制的一组网络和路由器称为一个自治系统(AS)。
    + 因特网被划分成多个自治系统，每个系统各归一个管理机构所有。一个自治系统可以自由地选择内
      部的路由选择体系结构和协议。
    + 在全球因特网中，每个大型 ISP 都是一个独立的自治系统，而自治系统之间的边界由两个 ISP 之
      间的对等商定组成。
- 自治系统之间的边界通信协议
    + 每个自治系统需要配置一个或多个路由器，与其他自治系统进行通信。
    + 路由器被配置用来了解和搜集自治系统内部网络相关的信息，并把这些信息传播出去；另外路由器
      还要接收其他自治系统中的网络有关信息，并把那些信息散布到自治系统内部。
    + 通过外部网关协议 EGP 协议在两个自治系统之间传递网络可达性信息。
    + 网络可达性与传播路由信息不同，EGP 并不是一个路由选择协议，但在实际应用中可能会不作区分。
    + 边界网关协议 BGP 是 EGP 的一种，是应用最广泛的外部网关协议。
    + 每个自治系统为自己指派一个路由器来运行 BGP，从而进行可达性信息交换。运行 BGP 的路由器互
      相成为彼此的对等端，这种路由器也称为边界网关或边界路由器。
- 边界网关协议 BGP
    + 特征
        + 用于自治系统间的通信；
        + 多个 BGP 路由器之间的协调：如果一个自治系统有多个路由器分别与外部自治系统中的对等端
          进行通信，可以使用一种形式的 BGP 来协调这一组路由器，确保它们能够传播一致的信息；
        + 可达性信息的传播；
        + 为每个目的站提供了下一跳信息；
        + 策略支持；
        + 可靠运输：BGP 使用 TCP 进行通信；
        + 路径信息；
        + 只对增量更新；
        + 支持无分类编址 CIDR；
        + 路由聚合；
        + 鉴别
    + 功能
        + 两个对等端建立 TCP 连接并进行报文交换，确保双方都同意进行通信；
        + 每一方发送肯定或否定的可达性信息；
        + 在通信过程中定期检验两个对等端及其相互之间的网络连接是否一切正常。
    + 报文类型
        + OPEN 报文
            + 两个 BGP 对等端一旦建立了 TCP 连接，就分别发送一个 OPEN 报文，报文中声明了各自
              的自治系统号码并建立其他操作参数。
            + OPEN 报文包含了一个保持计时器。每当有一个报文到达时，这个计时器被重置；如果计时
              超时，接收方则推断发送方不可用(并停止沿着从发送方那里获得的路径转发数据报)。
            + 当接收传入的 OPEN 报文时，使用 BGP 的机器通过发送一个 KEEPLIVE 报文作出响应。
        + UPDATE 报文
            + 一旦两个 BGP 对等端创建了一条 TCP 连接，发送 OPEN 报文并得到确认，对等端就使用 
              UPDATE 报文来通告可达的新目的站，或者当目的站变得不可达时撤销原先的通告。
        + KEEPLIVE 报文
            + 两个 BGP 对等端定期交换 KEEPALIVE 报文，以测试网络连通性，并确认两个对等端持续
              工作正常。
        + NOTIFICATION 报文
            + 一旦检测到永久性的差错问题，BGP 就会发送此通知报文，然后关闭 TCP 连接。
    + 约束
        + BGP 只能指出是否存在一条路径到达目的站，既不能传输也不能计算出哪条路径更短。
        + 当路由器从两个不同自治系统中的对等端接收到关于某个指定目的站的通告时，它不能比较两
          者的开销。也即 BGP 不能作为路由选择算法，因为即使一个路由知道有两条路径到达同一网络，
          也无法知道哪条路径更短。
        + 尽管 BGP 能够通告多条到某指定网络的路径，但它不允许多条路径同时使用，所有通信量都会沿
          着同一路径传输。
        + BGP 不支持任意自治系统之间的路由器平均分担负载。
        
## 自治系统内的路由选择
- 内部网关协议 IGP
    + 在一个自治系统内的两个路由器彼此互为内部路由器。
    + 由于没有单一标准，我们把内部路由器交换路由信息所有的任何协议统称为内部网关协议，简称 IGP。
    + 一个路由器可以同时使用两个不同的路由选择协议，一个用于到自治系统之外的通信，另一个用于自
      治系统内部的通信。
    + 具体来讲，运行 BGP 通告可达性的路由器通常还需要运行某种 IGP，以获得其自治系统内部的信息。
- 路由信息协议 RIP
    + 使用最广泛的一种 IGP 是路由信息协议(RIP)，底层 RIP 协议通过距离向量路由选择算法实现。
    + RIP 依靠物理网络广播来迅速交换路由信息，用于为其局域网上的机器提供一致的路由信息，是本地
      路由选择的基础。
    + RIP 路由选择实现
        + RIP 把路由选择的参与者分为主动机器和被动机器。
        + 主动路由向其他路由器通过广播通告其路由，而被动路由接收通告并在此基础上更新其路由，并
          不通告路由。只有路由器能以主动模式运行 RIP，而一般主机必须使用被动模式。
        + 运行 RIP 的主动机器和被动机器都要监听所有的广播报文，并根据前面所说的距离向量算法来
          更新其路由表。
        + 为了防止路由在开销相同的路径之间摇摆不定，RIP 规定在获得开销更小的路由之前保留原有路
          由不变。
        + RIP 规定所有监听方必须为通过 RIP 获得的路由设置计时器。当路由器收到 RIP 报文后必须重
          启定时器，超时内如果没收到通告报文则该路由变为无效路由。
- 开放SPF协议(OSPF)
    + 相比 RIP 只给每个目的站计算一条路由，OSPF 通过负载均衡为某个目的站规定了若干开销相同的路由。
    + OSPF 保证只有可信的路由器才能传播路由信息。
    + OSPF 允许每个多点接入的网络都有一个指定网关，即一个指定的路由器。
    + OSPF 允许路由器之间交换从外部网点获得的路由信息，并通过报文格式区分外部和内部路由信息。 