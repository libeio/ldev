
路由选择是在分组交换网中指的是为要发送的分组选择一条路径的过程。转发也是为分组选择路径的过程。

IP 的目的就是提供包含多个物理网络的一个虚拟网络，并提供无连接的数据报交付服务。与单个网络内的转发不同的是，IP 转发算法必须决定如何通过多个物理网络发送数据报。


### 转发形式

转发有两种形式: 直接交付和间接交付。

直接交付: 是把数据报从一台机器通过底层物理网络直接传输到另一台机器。
* 同一物理网络上两台机器之间传输IP数据报与路由器无关。发送方把数据报封装在一个物理帧中，把目的 IP 地址绑定到一个物理硬件地址，并把封装生成的帧直接发送到目的站。

间接交付: 发生在目的站不在一个直接相连的网络中时，从而强迫发送方把数据报传递给一个路由器进行交付。
* TCP/IP 互联网中的路由器形成一个相互协作的互连结构。数据报从一个路由器传递到下一个路由器，直到抵达一个可直接交付数据报的路由器。
* 发送方主机可以使用单个物理网络到达某个路由器。一旦这个帧到达该路由器，软件把封装的数据报提取出来，然后 IP 软件在通往目的站的路径上选择下一个路由器。数据报再将被放入一个帧，并通过下一个物理网络发送到下一个路由器，以此类推，直到它能够被直接交付。


### 转发实现

数据报在机器上的转发
* 数据报在机器上通过表驱动 IP 转发。
* 由于主机或路由器都为数据报选择路由，因此它们都有路由表。当主机或路由器中的 IP 转发软件需要传输数据报时，它就查询路由表来决定把数据报发往何处。

数据报在整个网络上的转发
* 数据报在整个网络上通过下一跳实现转发。
* 一个路由表包含许多对(N,R)，其中 N 是目的网络的 IP 地址，R 是通往网络 N 的路径上的"下一个"路由器的 IP 地址。路由器 R 称为下一跳，用路由表为每个目的站存储下一跳的做法称为下一跳路由选择或下一跳转发。
* 路由器 R 的路由表仅仅指明了从 R 到某个目的网络的路径上的下一步，路由器并不知道目的站的完整路径。
* 机器 M 的路由表列出的所有路由器必须位于 M 直接相连的网络上。当一个数据报准备好离开 M 时，IP 软件找到目的 IP 地址，并提取出地址的网络部分。然后 M 使用网络部分做出转发决策，选择一个可直接到达的路由器。

互联利用用 IP 地址实现转发过程
* 互联网转发算法只使用 IP 地址。
* IP 不保存下一跳地址。在执行转发算法后，IP 把数据报及下一跳地址传递给一个网络接口软件，该接口软件负责数据报必须发往的那个物理网络。
* 接口软件把下一跳地址绑定到一个物理地址，使用这个物理地址形成一个帧，把数据报放在该帧的数据部分，然后把形成的帧发送出去。在使用下一跳地址找到一个物理地址后，网络接口软件就会丢弃下一跳地址。


### 主机或路由如何处理传入的数据报

主机处理方式
* 当一个数据报到达主机时，网络接口软件就把它交付给 IP 模块进行处理。
* 如果数据报的目的地址与主机的 IP 地址匹配，则主机上的 IP 软件就接受该数据报，并把它传递给相应的高层协议软件进一步处理。如果目的 IP 地址不匹配，则要求主机丢弃该数据报(也就是说，禁止主机试图转发偶然错误转发给它的数据报)。

路由处理方式
* 当一个数据报到达路由器时，它被交付给 IP 软件。这以产生两种可能：数据报已到达它的最终目的站，或者可能需要继续传递。
* 与主机相同的是，如果数据报的目的 IP 地址与路由器自己的 IP 地址匹配，则 IP 软件把数据传递给高层协议软件进行处理。如果数据报还没有到达最终目的站，IP 就使用标准算法和本地路由表中的信息转发数据报。
* 没有被指派作为路由器的主机应该避免完成任何路由器的功能。

