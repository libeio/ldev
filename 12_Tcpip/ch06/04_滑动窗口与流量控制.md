
### 滑动窗口机制

如果 TCP 以 1 个段为单位，每发送一个段就进行一次确认应答的处理，那么很可能会因为包的往返时间过长造成通信性能的降低。

为解决这个问题，TCP 引入了滑动窗口机制。即使在往返时间较长的情况下，它也能控制网络性能的下降。

应用滑动窗口机制后，确认应答不再是以每个分段，而是以更大的单位(多个数据段)进行确认，这样转发时间将会被大幅度的缩短。也就是说，发送端主机在发送了一个段以后不需要一直等待确认应答，而是继续发送。


### 滑动窗口管理

最初的窗口大小是在连接建立过程中确定的。

源 TCP 进程将窗口内的所有字节顺序地组织成段，并试图无延迟地发送这些段。窗口由 3 个指针定义:
* "左"指针标记窗口的左边。此指针左侧数据流中的所有字节都是已经发送并被确认过的。此指针右侧的字节包含在传送窗口之中。
* "右"指针标记窗口的右边。此指针右侧的所有字节位于传送窗口外，无法被 TCP 进程发送。位于此指针与"左"指针之间的数据流中的所有字节都包含在传送窗口之中。
* "传送边界"指针定义窗口内的边界。窗口内位于此指针与"左"指针之间的所有字节已被发送，但是还没有得到确认。窗口内位于此指针与"右"指针之间的所有字节在接收到 ACK 之前可以发送。
* 如果"传送边界"指针到达标记窗口右边界的"右"指针，发送 TCP 进程必须停止段发送，并要等待 ACK 到达后窗口才能继续向右移动。

每个 TCP 连接维持着两个窗口。一个窗口随着数据的发送而滑动，另一个窗口则随着数据的接收而滑动。由于 TCP 连接属于全双工方式，两个连接的窗口可同步移动，用于发送和接收。

滑动窗口协议的性能与窗口大小和网络接收分组的速度有关。通过增加窗口大小，就有可能完全消除网络的空闲时间，解决高效传输和流量控制的问题。


### 流量控制

接收端因处理耗时占用、或其他高负荷下无法接收数据，因此而反复触发发送端的重传机制时，会导致网络流量的无端浪费。

为了解决这个问题，TCP 提供一种机制可以让发送端根据接收端的实际接收能力控制发送的数据量，这就是流量控制。它的具体操作是，接收端主机向发送端主机通知自己可以接收数据的大小，于是发送端会发送不超过这个限度的数据。该大小限度就被称作窗口大小，它是由接收端主机决定的。

TCP 首部中，专门有一个字段用来通知窗口大小。接收主机将自己可以接收的缓冲区大小放入这个字段中通知给发送端。这个字段的值越大，说明网络的吞吐量越高。

不过，接收端的这个缓冲区一旦面临数据溢出时，窗口大小的值也会随之被设置为一个更小的值通知给发送端，从而控制数据发送量。也就是说，发送端主机会根据接收端主机的指示，对发送数据的量进行控制。这也就形成了一个完整的 TCP 流量控制。

如果 TCP 进程不能再接收更多的数据，它通过发送一个通知窗口大小为 0 的 ACK 数据包来关闭接收窗口。TCP 进程在关闭窗口之后可以继续接收数据段，但这些段将不会得到确认。
