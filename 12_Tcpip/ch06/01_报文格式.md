
### TCP 报文格式

TCP 应用程序在两个应用进程之间传送数据的传输单元称为报文段。TCP 应用程序收集应用层递交的数据后，将其组成报文段。一个 TCP 报文段由 TCP 报头和数据两部分组成。

TCP 报文段
```shell
    |<-----------------------------20~65535B------------------------------->|
    |<-20~60B->|                                                            |
    +----------+------------------------------------------------------------+
    |   报头   |                          数据                               |
    +----------+------------------------------------------------------------+
```

TCP 报头格式如下:
```shell
    +---------------------------------+---------------------------------+
    |            源端口号              |             目的端口号           |
    +---------------------------------+---------------------------------+
    |                               序列号                               |
    +-------------------------------------------------------------------+
    |                               确认号                               |
    +--------+------------+-+-+-+-+-+-+---------------------------------+
    |报头长度 |  保留长度  |U|A|P|R|S|F|           窗口大小               |
    +--------+------------+-+-+-+-+-+-+---------------------------------+
    |            校验和                |           紧急指针              |
    +---------------------------------+---------------------------------+
    |                            选项和填充                              |
    +-------------------------------------------------------------------+
```
说明:
* 源端口号: 占用 16 比特，标识主机上发起传送的应用程序；
* 目的端口号字段: 占用 16 比特，标识主机上传送要到达的应用程序；
* 序列号字段: 占用 32 比特，标识报文段内第一个数据字节的序列号(存在同步序列号时除外)。存在同步序列号(SYN)时，该序列号字段为初始序列号(ISN)，因此第一个数据字节的序列号是 ISN+1。
* 确认号字段: 占用 32 比特，仅用于设置了 ACK 控制位的情况。ACK 号是数据段接送者预期接收的下一个序列号。例如，如果主机接收的序列号为 101，它将回送一个确认号设为 102 的段，表示希望接收序列号为 102 的段。不过，只有当标志位中的 ACK 标志为 1 时该确认序列号的字段才有效，该字段主要用来解决丢包的问题。
* 报头长度字段: 占用 4 比特，用来说明 TCP 报头共有多少个字节，1 个单位表示 4 个字节的长度。
* 保留字段: 占用 6 比特，通常设置为 0。
* 控制位字段: 占用 6 比特，定义了 6 种不同的控制位或标志，在同一时间可设置一位或多位标志。
    * URG - 值为 1 时表示紧急指针有效。告诉系统此报文段需要紧急处理。
    * ACK - 值为 1 时表示确认号有效，值为 0 时表示确认号无效。TCP 规定在连接建立后传送的所有报文段都必须把 ACK 置 1。
    * PSH - 值为 1 时表示有数据传输，当接收方收到 PSH=1 的报文段后，会立即将数据交付给应用程序，而不等到缓冲区满后再提交。一些交互式应用需要这样的功能，降低命令的响应时间。
    * RST - 值为 1 时表示 TCP 连接存在严重的错误，需要重新进行连接。
    * SYN - 值为 1 时表示这是一个连接请求或连接接受报文。当 SYN=1,ACK=0 时，表示当前报文段是一个连接请求报文，当 SYN=1,ACK=1 时，表示当前报文段是一个同意建立连接的应答报文。
    * FIN - 值为 1 时表示是一个释放连接的请求报文。
* 窗口大小字段: 占用 16 比特，用于端到端的流控制。该字段表明接收者可接收的字节数，从确认字段中的 1 开始。该字段具有双向性，也就是说，发送方和接收方都可以设置该字段的值。因此，连接的两端分别都能够控制另一端的数据流。
* 校验和字段: 占用 16 比特，证明分段传送无误。设备对 TCP 报头和应用程序数据的校验和进行计算。对错误分段丢弃处理。
* 紧急指针字段: 占用 16 比特，只在设置了 URG 位时才有效。此值是序列号的一个正偏移，它表示非紧急数据的开始，也就是紧急数据的结束。
* 选项字段: 占用 8 的倍数位比特，表示 TCP 选项长度可变的字段。
* 填充项字段: 附加 0 位，保证报头以 32 位结束。


### 序列号字段

在 TCP 报文段中，没有关于报文段编号的字段，但是有序列号和确认号两个字段。这两个字段涉及字节的编号而不是报文段的编号。

所谓字节编号，是指 TCP 应用程序把一个连接中发送的所有数据字节都编上号。当 TCP 应用程序从进程接收数据字节时，就把它们存储在发送缓存中，并为每个输出的数据字节分配一个唯一的序列号。初始序列号的选择是随机的。

当数据字节都被编号之后，TCP 应用程序就给每一个报文段指派一个序号。每个报文段的序号就是这个报文段中的第一个数据字节的序号。

TCP 并不会对每个字节的序列号进行确信，而是采用了一种累积式确认机制。TCP 接收方向发送方发送一个带有序列号为 X 的确认(ACK)段，表示目的主机已接收到截至X(但不含X)的所有字节。

TCP 是一种全双工的字节流传输服务，其连接的每一方都有一个自己的序列号组。


### TCP 协议传输单元

TCP 的协议传输单元称为段(Segment)，其重要特征为最大消息长度(MSS: Maximum Segment Size)。最理想的情况是，最大消息长度正好是 IP 中不会被分片处理的最大数据长度。

TCP 在传送大量数据时，是以 MSS 的大小将数据进行分割发送，进行重发时也是以 MSS 为单位。

MSS 是在三次握手的时候，在两端主机之间被计算得出的。两端的主机在发出建立连接的请求时，会在 TCP 首部中写入 MSS 选项，告诉对方自己的接口能够适应的 MSS 的大小。然后会在两者之间选择一个较小的值投入使用。

TCP 通过最大报文段长度(MSS)选项来允许接收方指出自己愿意接受的最大报文段长度。
