

这里仅针对 IPv4 报文进行说明。

在一个物理网络上，IP 协议传输单元是一个包含首部和数据的帧，首部给出了(物理)源地址和目的地址之类的信息。互联网把它的基本传输单元称为 Internet 数据报(也称为 IP 数据报或数据报)。

IPv4 数据报格式限制数据报的长度为 2^16 个字节。但数据报通常最好不要超过 1500 个字节(这是以太网帧的最大MTU)，以避免报文分组与重组带来的传输消耗。



### 报文格式

由 IP 报头和数据两部分组成。IP 报头包含一个 20 字节的固定长度部分和一个可变长度部分，后者最多可达 40 字节，包含有关路由选择和交付的重要信息。
```shell
    |<-----------------------------20~65535B------------------------------->|
    |<-20~60B->|                                                            |
    +----------+------------------------------------------------------------+
    |   报头   |                          数据                              |
    +----------+------------------------------------------------------------+

    IP 报头内容如下:
    +----------+----------+--------------------+----------------------------------------+
    |  版本号   | 报头长度 |     区分服务        |                总长度                   |
    +----------+----------+--------------------+-----+----------------------------------+
    |                标识符                     |标志 |           段偏移值                |
    +----------+----------+--------------------+-----+----------------------------------+
    |     生存时间         |     协议类型        |             报头校验和                  |
    +---------------------+--------------------+----------------------------------------+
    |                                  源 IP 地址                                        |
    +-----------------------------------------------------------------------------------+
    |                                 目的 IP 地址                                       |
    +-----------------------------------------------------------------------------+-----+
    |                               可选项（0或多个）                               |填充 |
    +-----------------------------------------------------------------------------+-----+
```

字段说明
* 版本号: 占用 4 个比特。
* 报头长度: 占用 4 个比特，用于表示 32 比特字长的报头长度。1 个单位表示 4 个字节的长度，不含填充时值为 5 ，表示 20 个字节。
* 区分服务: 用于指定数据报所要求的服务质量(QoS)。
* 总长度字段: 
    * 占用 16 个比特，用于表明 IP 数据报的字节长度，其中包括报头长度和数据长度(数据长度 = 总长度 - 报头长度)。IP 数据报的最大长度为 65535 字节，而所有主机必须支持的数据包最短长度为 576 字节。
    * 大多数数据报被分段并封装在较小的多个帧中。
* 标识符字段:
    * 每个数据报都必须由唯一的标识符来标识，以便使接收主机能确定新到达的分段属于哪一个数据报，从而重装被分段的数据报。
    * 同一个数据报的所有分段包含同样的标识符。标识符字段占用 16 个比特。
* 标志位字段:
    * 占用 3 个比特，用于分段控制。这 3 个位(从左到右依次为第 0 位到第 2 位)的含义如下: 第 0 位为预留位。第 1 位为可否分段标志位: 当该位的值为 0 时，表示数据报不可分段；其值为 1 时，表示数据报可被分段。第 2 位为段是否结束位: 当该位的值为 0 时，表示该段是原数据报的最后一段；其值为 1 时，表示后面还有更多的分段。
    * 当网络设备要发送的数据报长度比所在网络的最大传输单元大，同时标志位的第 1 位设置为不能分段(值为 0)时，网络设备会向发送方返回一个因特网控制消息协议(ICMP)错误消息，并丢弃该数据报。
* 段偏移字段: 占用 13 个比特，用于指定分段在原始数据中的相对位置。第 1 个分段的段偏移字段为 0，其余分段的段偏移以 8 个字节为单位进行计数，表示该段数据在原始数据报数据区中的偏移量。
* 生存时间字段: 占用 8 个比特，用于指定数据报允许保留在网络上的时间(单位是秒)。数据包经过每个网关和主机时，都对该字段的值递减 1 ,当其值为 0 时网络设备便丢弃该数据包，并向源站发送一个差错报文。
* 协议字段: 占用 8 个比特，用于指定数据报数据区中携带的消息是由哪种高级协议建立的。例如，TCP 协议号是 0x06 ，UDP 协议号是 0x17 ,ICMP 协议是 0x01，IGMP 协议是 0x02。更多查看 RFC 790。
* 报头校验和字段: 占用 16 个比特，当报头每经过一个跳步时，校验和都会被重新计算。该字段只校验数据报的首部，不校验数据部分，它主要用来确保 IP 数据报不被破坏。
* 源 IP 地址和目的 IP 地址: 均占用 32 个比特。在数据包通过网络传送的过程中其值不会发生变化。
* 选项字段: 长度可变，它用于各种选项，如记录所采用的路由、指定要采用的路由以及时间标记等。其主要上手是为网络管理员提供测试和调试网络的工具。
* 填充字段: 保证 IP 报头以 32 位结束。


### 报文封装

IP 报头和 IP 数据在以太网帧中的数据封装如下:
```shell
    +----------+----------+----------+-----------------------------+-----------------+
    | 目的地址  |  源地址  | 长度类型  | 以太网数据(IP 报头 + IP 数据) | 循环冗余检验(CRC)|
    +----------+----------+----------+-----------------------------+-----------------+
```
说明:
* 物理网络帧必须由硬件识别，而数据报是在软件中进行处理的。
* 为使互联网的传输更为有效，会将每个数据报放入独立的物理帧中传输，这种传输方式称为封装。
* 物理帧在网络中传输时也叫网络物理帧或网络帧。
