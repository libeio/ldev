
NAT(Network Address Translator)是用于在本地网络中使用私有地址，在连接互联网时转而使用全局 IP 地址的技术。除转换 IP 地址外，还出现了可以转换 TCP、UDP 端口号的 NAPT(Network Address Ports Translator)技术，由此可以实现用一个全局 IP 地址与多个主机的通信。这种方式也称为网络地址端口转换或端口映射。


### NAT 的工作机制

在NAT(NAPT)路由器的内部，有一张自动生成的用来转换地址的表，这种转换表在 NAT 路由器上自动生成。当私网 IP 向公网 IP 发送第一个包时会生成这张表，并按照表中的映射关系进行处理。例如，在 TCP 的情况下，建立 TCP 连接首次握手时的 SYN 包一经发出，就会生成这个表，而后又随着收到关闭连接时发出 FIN 包的确认应答从表中被删除。

当私有网络内的多台机器同时都要与外部进行通信时，仅仅转换 IP 地址会导致全局地址耗尽情况。这时采用 NAPT 方式可以解决这个问题。


### NAPT 的工作机制

NAPT 通过 TCP 或 UDP 协议端口号以及地址来提供并发性。

把 NAT 转换表进行扩展，除了一对源和目的 IP 地址以外，另外加上一对源和目的协议端口号，以及 NAT 盒使用的一个协议端口号，就是 NAPT 。

TCP 用一个四元组来标识一个连接，这个四元组代表了两端各自的 IP 地址和协议端口号:
```shell
    (10.0.0.5, 21023, 128.10.19.20, 80)
    (10.0.0.1, 386, 128.10.19.20, 80)
```
表中前两项对应的是两台内部主机各自的 TCP 连接。

但是，同样是上面两条 TCP 连接，在执行了 NAPT 转换后，因特网中接收数据报的计算机在识别它们时用的是下面的四元组：
```shell
    (G, 14003, 128.10.19.20, 80)
    (G, 14010, 128.10.19.20, 80)
```
其中，G 是 NAT 盒的全球有效地址。

端口映射 NAT 能够仅用一个全球有效 IP 地址获得通用性。

此种方式通信仅限于 TCP 或 UDP。只要所有通信都采用 TCP 或 UDP，NAPT 就允许一台内部计算机访问多台外部计算机，并允许多台内部计算机访问同一台外部计算机，相互之间不会发生冲突。


### NAT 的潜在问题

由于 NAT(NAPT) 都依赖于自己的转换表，因此会有如下几点限制:
* 无法从 NAT 的外部向内部服务器建立连接。
* 转换表的生成与转换操作都会产生一定的开销。
* 通信过程中一旦 NAT 遇到异常需重新启动时，所有的 TCP 连接都将被重置。
* 即使备置两台 NAT 做容灾备份，TCP 连接还是会被断开。
