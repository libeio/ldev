

## 长连接
- http1.1 缺省情况下为长连接，即 keepalive。
- http 基于 tcp 流协议。长连接情况下， http 通过协议规则来分割数据包，每个数据包由头部和内
  容组成。先获取头部，从中得到 Content-Length，然后获取 Content(也可以根据某标记获取)。就
  这样从流中拿到一个个相对独立的数据包进行处理。
- http 长连接对数据的处理，类似于直接使用 tcp 对数据的处理。

## 长连接的关闭与超时后维持
- http 一般都是服务端先主动关闭(因为只有它知道自己提供的服务是否完毕)。但长连接情况下，服
  务端一般不主动关闭，而是通过判断是否超时来进行关闭。
- 长连接情况下，服务端有超时设置，超过设定时间没有新数据就关闭连接。超时时长由自己设定。
- 超时后如果不想关闭这个长连接，可以发送心跳包维持。
- http 的长连接应该是短暂的，比如 1 秒。考虑到网速问题，可以设置为 5 秒。

## tcp 通信对端断开的三种方式及处理
- 一种是显式调用 close ，属于优雅的关闭，对端也会收到关闭的消息；
- 一种是程序崩溃，属于非优雅的关闭，操作系统回收 socket 句柄时，会通知对方，具体取决于操作
  系统的实现。应用层处理方法是直接杀进程；
- 最后一种是拔掉网线，即掉线情况。一般是开启底层(tcp协议中)的 keepalive。

## tcp 协议层的 keepalive
- tcp 协议层的 keepalive 指的是心跳包，而 http 里说的 keepalive 是长连接，两者是不同的概念。
- tcp 的 keepalive 又分为两种，一种是 tcp 协议自己规定的 keepalive 机制，应用层无感；一种是
  应用层中由开发者自定义实现的心跳包。
- 一般情况下，如果只是检测连接是否丢失，可以直接使用底层 tcp 的 keepalive 。如果使用应用层
  的 keepalive，会产生效率损失。除非需要持续报告状态，传递有效数据等。

## 更多参考
[TCP keepalive的详解(解惑)](https://www.cnblogs.com/lanyangsh/p/10926806.html)