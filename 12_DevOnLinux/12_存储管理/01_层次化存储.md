
存储器系统是一个具有不同容量、成本和访问时间的存储设备的层次结构。


### 为什么要进行层次化存储

存储器系统是一个具有不同容量、成本和访问时间的存储设备的层次结构。存储层次从高到低一般分为:
* 寄存器: 用作 CPU 指令集运算的存储单元
* 高速缓存: 也称为 CPU 缓存、SRAM 等
* 主存: 通俗意义上的内存就是指这个，学名 DRAM。增强型的 DRAM 有 SDRAM(Synchronous DRAM, 同步DRAM) 以及 DDR-SDRAM(Double Data-rate Synchronous DRAM, 双倍数据速率同步DRAM)
* 辅存: 也称为外存，如磁盘、固态硬盘等

存储层次越高，其访问速度越快，造价也越昂贵。
```shell
    从磁盘上读信息的时间为毫秒级，从 DRAM 读比从磁盘读快 10 万倍，从 SRAM 读比
    从磁盘读快 100 万倍。
```

在计算机程序中，倾向于多次地访问相同的数据项集合，或是倾向于访问邻近的数据项集合。而具有良好局部性的程序比局部性差的程序更多地倾向于从存储层次结构中较高层次处访问数据项，从而使程序运行得更快。

这也是计算机程序的一个基本属性——局部性(locality)。


### 总线

总线(bus)是一组并行的导线，按照传递数据类型的不同可以分为三类: 地址总线、数据总线和控制总线。地址总线和数据总线有时会共享，不同的设备也可能共享同一根总线。

按照总线功能的不同，又会有不同的叫法。比如连接 CPU 和 I/O 桥的总线称为`系统总线`(system bus)，连接 I/O 桥与主存的总线称为`存储器总线`(memory bus)，连接各类 I/O 设备的总线称为 `I/O 总线`，等等。


### 处理器与主存

数据流通过总线(bus)在处理器和 DRAM 主存之间来回传送，数据流传送的过程频繁称为总线事务(bus transaction)。

读事务(read transaction)从主存传送数据到CPU。写事务(write transaction)从 CPU 传送数据到主存。

![](img/12_CPU和主存的总线结构.jpg "典型的CPU和主存的总线结构")

根据上图，接下来对读事务和写事务进行举例说明。

读事务: 地址 A 的内容被加载到寄存器 `%eax` 中。
```s
    movl A, %eax
```
CPU 芯片上的总线接口发起读事务。读事务由三个步骤组成:
* 首先，CPU 将地址 A 放到系统总线上。I/O 桥将信号传递到存储器总线。
* 其次，主存感知到存储器总线上的地址信号，从存储器总线读地址，主存根据该地址从 DRAM 取出数据字，并将数据写到存储器总线。I/O 桥将存储器总线信号翻译成系统总线信号，然后沿着系统总线传递。
* 最后，CPU 感知到系统总线上的数据，从总线上读数据，并将数据拷贝到寄存器 `%eax` 中。

写事务: 寄存器 `%eax` 的内容被写到地址 A 上。
```s
    movl %eax, A
```
同样由 CPU 发起写事务，包括三个基本步骤:
* 首先，CPU 将地址放到系统总线上。存储器从存储器总线读出地址，并等待数据到达。
* 其次，CPU 将 `%eax` 中的数据字拷贝到系统总线。
* 最后，主存从存储器总线读出数据字，并且将这些位存储到 DRAM 中。


### I/O 设备与存储器

I/O 总线要比系统总线和存储器总线慢，它是连接显示器、鼠标、键盘、磁盘等各种计算机外设的一类总线，接入 I/O 桥后进行数据流的传送。

![](img/12_IO总线.jpg "IO总线")

不像系统总线和存储器总线一样，I/O 总线与 CPU 并无直接关联。当一个设备连接到 I/O 总线上时，该设备就与一个或多个`I/O端口`相关联，这类端口实际上是为与 I/O 设备通信而设定的保留地址。CPU 即是通过`存储器映射I/O`技术来向 I/O 设备发出命令的。
